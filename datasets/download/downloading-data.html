<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Bigpicture - Download guide</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../favicon.ico" rel="icon">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../images/bp-logo-one-line.png" alt="BigPicture" class="navbar-logo">
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-datasets" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Datasets</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-datasets">    
        <li>
    <a class="dropdown-item" href="https://datasets.bp.nbis.se/">
 <span class="dropdown-text">Browse</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://bp-demo.rahtiapp.fi/">
 <span class="dropdown-text">Demo Search</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../datasets/download/downloading-data.html">
 <span class="dropdown-text">Download</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../datasets/submission/index.html">
 <span class="dropdown-text">Submission</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-algorithms" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Algorithms</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-algorithms">    
        <li>
    <a class="dropdown-item" href="../../algorithms/browse/index.html">
 <span class="dropdown-text">Browse</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../algorithms/try/index.html">
 <span class="dropdown-text">Try</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../algorithms/benchmark/index.html">
 <span class="dropdown-text">Benchmark</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../algorithms/submit/index.html">
 <span class="dropdown-text">Submit</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-compute" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Compute</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-compute">    
        <li>
    <a class="dropdown-item" href="../../compute/analysis/index.html">
 <span class="dropdown-text">Analysis</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../compute/ai-training/index.html">
 <span class="dropdown-text">AI Training</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="https://doc.cytomine.com#/"> 
<span class="menu-text">Software</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-metrics" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Metrics</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-metrics">    
        <li>
    <a class="dropdown-item" href="../../metrics/index.html">
 <span class="dropdown-text">Dashboard</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://grafana.bp.nbis.se/public-dashboards/c465fe145d7844b59d7eea87be8e199d#/" target="_blank">
 <span class="dropdown-text">Archive Status</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#get-access-to-a-dataset" id="toc-get-access-to-a-dataset" class="nav-link active" data-scroll-target="#get-access-to-a-dataset">Get access to a dataset</a></li>
  <li><a href="#preparation-for-downloading-data" id="toc-preparation-for-downloading-data" class="nav-link" data-scroll-target="#preparation-for-downloading-data">Preparation for downloading data</a>
  <ul class="collapse">
  <li><a href="#download-configuration-file" id="toc-download-configuration-file" class="nav-link" data-scroll-target="#download-configuration-file">Download configuration file</a></li>
  <li><a href="#install-the-sda-cli-tool" id="toc-install-the-sda-cli-tool" class="nav-link" data-scroll-target="#install-the-sda-cli-tool">Install the sda-cli tool</a></li>
  <li><a href="#generate-the-public-and-secret-key" id="toc-generate-the-public-and-secret-key" class="nav-link" data-scroll-target="#generate-the-public-and-secret-key">Generate the public and secret key</a></li>
  </ul></li>
  <li><a href="#check-access" id="toc-check-access" class="nav-link" data-scroll-target="#check-access">Check access</a></li>
  <li><a href="#download-data" id="toc-download-data" class="nav-link" data-scroll-target="#download-data">Download data</a>
  <ul class="collapse">
  <li><a href="#download-files" id="toc-download-files" class="nav-link" data-scroll-target="#download-files">Download file(s)</a></li>
  <li><a href="#download-dataset-for-sda-cli-version-0.1.3" id="toc-download-dataset-for-sda-cli-version-0.1.3" class="nav-link" data-scroll-target="#download-dataset-for-sda-cli-version-0.1.3">Download dataset (for sda-cli version = 0.1.3)</a></li>
  </ul></li>
  <li><a href="#decrypt-the-data" id="toc-decrypt-the-data" class="nav-link" data-scroll-target="#decrypt-the-data">Decrypt the data</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Download guide</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>This section provides guidelines on the necessary steps to download data from BigPicture.</p>
<section id="get-access-to-a-dataset" class="level2">
<h2 class="anchored" data-anchor-id="get-access-to-a-dataset">Get access to a dataset</h2>
<p>The first step to download data from Big Picture is to get access to the dataset the user is interested in. This can be done by visiting REMS <a href="https://bp-rems.sd.csc.fi/">here</a>. Log in, choose the datasets of interest and add them to the cart. After that, the user can apply for access, fill in the form and send the application. The user needs to wait for approval from the data access committee (DAC) and after it has been approved the user can download the datasets.</p>
</section>
<section id="preparation-for-downloading-data" class="level2">
<h2 class="anchored" data-anchor-id="preparation-for-downloading-data">Preparation for downloading data</h2>
<section id="download-configuration-file" class="level3">
<h3 class="anchored" data-anchor-id="download-configuration-file">Download configuration file</h3>
<p>Before downloading the data, the user needs to download the configuration file by logging in <a href="https://login.bp.nbis.se/">here</a>. Follow the dialogue to get authenticated and then click on <code>Download inbox s3cmd credentials</code> to download the configuration file named <code>s3cmd.conf</code>.</p>
</section>
<section id="install-the-sda-cli-tool" class="level3">
<h3 class="anchored" data-anchor-id="install-the-sda-cli-tool">Install the sda-cli tool</h3>
<p>Follow the guidelines <a href="../../datasets/submission/submission-guide.html#install-the-sda-cli-tool">here</a> to install the sda-cli tool.</p>
</section>
<section id="generate-the-public-and-secret-key" class="level3">
<h3 class="anchored" data-anchor-id="generate-the-public-and-secret-key">Generate the public and secret key</h3>
<p>The initial step involves creating a crypt4gh keypair using the sda-cli:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./sda-cli</span> createKey <span class="op">&lt;</span>keypair_name<span class="op">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>where <code>&lt;keypair_name&gt;</code> is the base name of the key files. The above command will create two key files named <code>keypair_name.pub.pem</code> and <code>keypair_name.sec.pem</code>. The public key (<code>pub</code>) will be used alongside with <code>sda-cli</code> and will be used by the system for encryption of the files before downloading, while the private one (<code>sec</code>) will be used by the requester for decrypting the files after downloading.</p>
</section>
</section>
<section id="check-access" class="level2">
<h2 class="anchored" data-anchor-id="check-access">Check access</h2>
<p>After the user has been granted access to the dataset, the user can check access to the dataset by listing the datasets and their files using the <code>sda-cli</code>. For listing the datasets that the user has access to, the user needs to run:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./sda-cli</span> list <span class="at">-config</span> s3cmd.conf <span class="at">--datasets</span> <span class="at">--url</span> https://download.bp.nbis.se <span class="er">(</span><span class="ex">--bytes</span><span class="kw">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>For listing the files of a specific dataset, the user needs to run:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./sda-cli</span> list <span class="at">-config</span> s3cmd.conf <span class="at">-dataset</span> <span class="op">&lt;</span>DatasetID<span class="op">&gt;</span> --url https://download.bp.nbis.se <span class="er">(</span><span class="ex">--bytes</span><span class="kw">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>where <code>&lt;DatasetID&gt;</code> is the ID of the dataset for which the user wants to list the files. The dataset ID can be found by running the previous command.</p>
</section>
<section id="download-data" class="level2">
<h2 class="anchored" data-anchor-id="download-data">Download data</h2>
<section id="download-files" class="level3">
<h3 class="anchored" data-anchor-id="download-files">Download file(s)</h3>
<p>After having acquired access to the datasets, the configuration file and the sda-cli tool, the user can download the encrypted data. The user needs to provide the public key that was generated earlier, as well as the configuration file.</p>
<p>To download the data:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./sda-cli</span> download <span class="at">-config</span> s3cmd.conf <span class="at">-pubkey</span> <span class="op">&lt;</span>public-key-file<span class="op">&gt;</span> -dataset-id <span class="op">&lt;</span>DatasetID<span class="op">&gt;</span> --url https://download.bp.nbis.se <span class="at">-outdir</span> <span class="op">&lt;</span>/path/to/output/directory<span class="op">&gt;</span> <span class="op">&lt;</span>filepath_1_to_download<span class="op">&gt;</span> <span class="op">&lt;</span>filepath_2_to_download<span class="op">&gt;</span> ...</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>where:</p>
<ul>
<li><code>&lt;public-key-file&gt;</code> is the public key file that was generated earlier (<code>&lt;keypair_name&gt;.pub.pem</code>)</li>
<li><code>&lt;DatasetID&gt;</code> is the ID of the dataset for which the user wants to download the files</li>
<li><code>&lt;/path/to/output/directory&gt;</code> is the path to the directory where the files will be downloaded</li>
<li><code>&lt;filepath_*_to_download&gt;</code> are the file paths of the files which can be found by listing the files of the dataset as described above</li>
</ul>
</section>
<section id="download-dataset-for-sda-cli-version-0.1.3" class="level3">
<h3 class="anchored" data-anchor-id="download-dataset-for-sda-cli-version-0.1.3">Download dataset (for sda-cli version = 0.1.3)</h3>
<p>To download the whole dataset, the user can do it in two steps. First, the user needs to list the files of the dataset and save the file paths to a file by running the following command:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./sda-cli</span> list <span class="at">-config</span> s3cmd.conf <span class="at">--datasets</span> <span class="at">--url</span> https://download.bp.nbis.se <span class="kw">|</span> <span class="fu">awk</span> <span class="st">'{hold=$4} NR&gt;1{print prev} {prev=hold}'</span> <span class="op">&gt;</span> filepaths.txt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and then download them by using the saved file from the previous step:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./sda-cli</span> download <span class="at">-config</span> s3cmd.conf <span class="at">-pubkey</span> <span class="op">&lt;</span>public-key-file<span class="op">&gt;</span> -dataset-id <span class="op">&lt;</span>DatasetID<span class="op">&gt;</span> --url https://download.bp.nbis.se <span class="at">-outdir</span> <span class="op">&lt;</span>/path/to/output/directory<span class="op">&gt;</span>  --from-file filepaths.txt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="decrypt-the-data" class="level2">
<h2 class="anchored" data-anchor-id="decrypt-the-data">Decrypt the data</h2>
<p>After downloading the encrypted data, the user can decrypt the files using the private key that was generated earlier by running:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./sda-cli</span> decrypt <span class="at">-key</span> <span class="op">&lt;</span>keypair_name<span class="op">&gt;</span>.sec.pem <span class="op">&lt;</span>/path/to/encrypted/file<span class="op">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>where <code>&lt;/path/to/encrypted/file&gt;</code> is the path to the encrypted file that the user wants to decrypt and <code>&lt;keypair_name&gt;.sec.pem</code> is the private key file that was generated earlier.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>